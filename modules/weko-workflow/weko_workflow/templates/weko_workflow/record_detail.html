{#
 # This file is part of WEKO3.
 # Copyright (C) 2017 National Institute of Informatics.
 #
 # WEKO3 is free software; you can redistribute it
 # and/or modify it under the terms of the GNU General Public License as
 # published by the Free Software Foundation; either version 2 of the
 # License, or (at your option) any later version.
 #
 # WEKO3 is distributed in the hope that it will be
 # useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
 # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 # General Public License for more details.
 #
 # You should have received a copy of the GNU General Public License
 # along with WEKO3; if not, write to the
 # Free Software Foundation, Inc., 59 Temple Place, Suite 330, Boston,
 # MA 02111-1307, USA.
 #}

{% from "weko_records_ui/box/preview_carousel.html" import preview_carousel %}

{%- if record !=[] -%}
<div class="panel panel-default">
  <div class="panel-heading clearfix">
    <h3 class="panel-title" style="display: inline;">{{_('Item')}}</h3>
    <a href="#"><span class="glyphicon glyphicon-file" aria-hidden="true" style="margin-left: 0.25em;"></span> {{ record.get('item_title', _('No title')) }}</a>
  </div>
  <div class="panel-body">
    <div class="panel-body">
      <div class="row">
        <div class="col-sm-12 col-md-12 col-left">
          {%- block record_author %}
            {%- set ignore_meta = ('_buckets', '_deposit', '_oai', 'path', 'filemeta', 'item_title', 'item_type_id') -%}
            {%- if files | selectattr('is_thumbnail', 'equalto', False)| list | length > 0-%}
            <!-- Preview Carousel -->
            {{ preview_carousel(record=record, files=files, pid=pid, el_id=preview_carousel_id, edit_page_prev=True) }}
            <hr />
            <table class="table table-bordered table-striped">
              <thead>
              <tr >
                <th>{{_('Name')}} / {{_('File')}}</th>
                <th class="license">{{_('License')}}</th>
              </tr>
              </thead>
              <tbody>
              {%- for file in files|sort(attribute='key') -%}
              {% if file.is_thumbnail == False %}
                {%- set img = file.mimetype | get_image_src -%}
                {%- set file_url = url_for('invenio_records_ui.recid_files', pid_value=pid.pid_value,
                filename=file.key) %}
                <tr >
                  <td >{{file.filename or file.key}}</td>
                  <td rowspan="2">
                    {%- if not 'simple' in file.displaytype -%}
                      {%- if 'license_free' == file.licensetype -%}
                        <span class="break-word">{{ file.licensefree }}</span>
                      {%- else %}
                      {% set lst = file.licensetype | get_license_icon %}
                        <a target="_blank" href="{{lst[2]}}" alt="Creative Commons Licenses">
                        <img src="{{lst[0]}}" alt="license.icon" /></a><br>
                        {{ lst[1] }}
                      {%- endif %}
                    {%- endif -%}
                  </td>
                </tr>
                <tr >
                  <td>
                      <span class="filename">
                        <img src="{{img}}" alt={{file.filename or file.key}} />
                        <a class="forcewrap"
                            href="{{file_url}}">{{ file.filename or file.key }} ({{ file.size|filesizeformat }})</a>
                        <!--<span>[ 0 downloads ]</span><br>-->
                        <span>{{file.checksum.split(':')[0]}}</span>
                        <span class="break-word">{{file.checksum.split(':')[1]}}</span>
                      </span>
                  </td>
                </tr>
                <!-- demo -->
                {%- if record | check_permission -%}
                {%- if 'pdf' in file.mimetype -%}
                    <tr><td colspan="2">
                  <a class="btn btn-default" id="btn_check" href="/ezas/pdf-detect-weko.html" target="_blank">
                  <span class="glyphicon glyphicon-edit"
                    aria-hidden="true"></span> {{_('Plagiarism Check')}}</a>
                </td></tr>
                {%- endif -%}
                {%- endif -%}
              {%- endif -%}
              <!-- demo -->
              {%- endfor -%}
              </tbody>
            </table>
            {%- endif %}
            <table class="table table-bordered table-striped">
              {% if record.item_type_info %}
                <tr>
                  <th>{{_('Item Type')}}</th>
                  <td>{{ record.item_type_info }}</td>
                </tr>
              {% endif %}
              {%- for lst in record.items_show_list %}
                {% if 'attribute_name_hidden' not in lst.keys() %}
                <tr>
                  <th>{{ lst['attribute_name'] }}</th>
                  <td>
                    <pre class="hide">{{lst|tojson}}</pre>
                    {% if lst['attribute_value'] is string %}
                      {{ lst['attribute_value'] }}
                    {% else %}
                      {%- for key in lst['attribute_value'] %}
                        {{ key }}
                      {% endfor %}
                    {% endif %}
                    {% if lst['attribute_type'] == 'creator' %}
                      {%- for l in lst['attribute_value_mlt'] if l %}
                        {%- for creatorName in l['creatorNames'] if creatorName -%}
                          {%- if 'name' == config['ITEM_SEARCH_FLG'] -%}
                            {%- set q = 'creator='+creatorName['creatorName'] -%}
                          {%- else -%}
                            {%- set q = 'id='+l['weko_id'] -%}
                          {%- endif -%}
                          <a href="{{url_for('invenio_search_ui.search')+'?q=&'+q}}">{{ creatorName['creatorName'] }}</a><label class="p-left-10"></label><br/>
                        {%- endfor -%}
                        <br>
                        {%- for nameIdentifier in l['nameIdentifiers'] if nameIdentifier -%}
                          {%- if nameIdentifierScheme in nameIdentifier.keys() and nameIdentifier['nameIdentifierScheme'] != "" -%}
                            {%- if nameIdentifier['nameIdentifierURI']|length > 0 -%}
                              {%- set nid = nameIdentifier['nameIdentifierURI'] -%}
                            {%- else -%}
                                  <!--
                              {%- set nid = 'http://'+nameIdentifier['nameIdentifierScheme']+'.io/'+ nameIdentifier['nameIdentifier'] -%}
                              -->
                              <!-- demo -->
                              {%- set nid = nameIdentifier['subitem_1522319059692'] -%}

                            {%- endif -%}
                            <label class="p-left-10">{{nameIdentifier['nameIdentifierScheme']}}: </label><a href="{{nid}}">{{ nameIdentifier['nameIdentifier'] }}</a><br/>
                          {%- endif -%}
                        {%- endfor -%}
                        {%- for creatorMail in l['creatorMails'] if creatorMail -%}
                          <label class="p-left-10">e-mail: </label><a href="{{'mailto:'+creatorMail['creatorMail']}}">{{ creatorMail['creatorMail'] }}</a><br/>
                        {%- endfor -%}
                      {% endfor %}
                    {% else %}
                      {%- for l in lst['attribute_value_mlt'] %}
                        {%- for k, v in l.items() %}
                          {{ v }}<br>
                        {% endfor %}
                      {% endfor %}
                    {% endif %}
                  </td>
                </tr>
                {% endif %}
                {%- if 'attribute_name_hidden' in lst.keys() and files_thumbnail -%}
                  <tr>
                    <th>{{lst.get('attribute_name_hidden', _('Thumbnail'))}}</th>
                    <td>
                      {%- for thumb in files_thumbnail | sort(attribute='key') -%}
                        {%- set thumb_name = thumb.filename or thumb.key -%}
                        {%- set thumb_url = url_for('invenio_records_ui.recid_files', pid_value=pid.pid_value,
                        filename=thumb.key) %}
                        <p>
                          <span>{{ thumb_name }}</span><br>
                          <img src="{{thumb_url}}" alt={{thumb_name}} style="max-width:  {{ config.WEKO_RECORDS_UI_DEFAULT_MAX_WIDTH_THUMBNAIL }}px;" />
                        </p>
                      {% endfor %}
                      </td>
                    </tr>
                {% endif %}
              {% endfor %}
            </table>
            {%- if 'main_entry_personal_name' in record %}
            <p class="record_authors">
              <i>{{ record['main_entry_personal_name']['personal_name'] }}</i>
              {%- for author in record.get('added_entry_personal_name', []) %}
              , <i>{{ author['personal_name'] }}</i>
              {% endfor %}
            </p>
            {% endif %}
          {%- endblock %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}
<br>
